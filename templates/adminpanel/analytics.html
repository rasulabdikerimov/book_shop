{% extends 'adminpanel/base.html' %}
{% block title %}Analytics ‚Äî Admin{% endblock %}
{% block header %}üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞{% endblock %}

{% block content %}
<div class="panel">
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–µ—Ä–∏–æ–¥–æ–≤ -->
    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; display: flex; gap: 15px; align-items: center;">
        <strong>–ü–µ—Ä–∏–æ–¥:</strong>
        <a href="?period=month" class="btn {% if period == 'month' %}{% else %}muted{% endif %}" style="{% if period == 'month' %}background-color: #0066cc; color: white;{% endif %}">üìÖ –ú–µ—Å—è—Ü</a>
        <a href="?period=year" class="btn {% if period == 'year' %}{% else %}muted{% endif %}" style="{% if period == 'year' %}background-color: #0066cc; color: white;{% endif %}">üìà –ì–æ–¥</a>
        <span style="margin-left: auto; font-weight: bold; color: #333;">{{ period_name }}</span>
    </div>

    <!-- –°–µ—Ç–∫–∞ –¥–∏–∞–≥—Ä–∞–º–º -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px;">
        
        <!-- 1. –¢–û–ü –ö–ù–ò–ì -->
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                <h3 style="margin:0; color: #333;">üìö –¢–æ–ø –∫–Ω–∏–≥–∏</h3>
                <div style="margin-left: auto; display:flex; gap:8px;">
                    <a href="?period={{ period }}&sort=sales" class="btn {% if sort != 'views' %}{% else %}muted{% endif %}" style="{% if sort != 'views' %}background-color:#0066cc;color:white;{% endif %}">–ü–æ –ø—Ä–æ–¥–∞–∂–∞–º</a>
                    <a href="?period={{ period }}&sort=views" class="btn {% if sort == 'views' %}{% else %}muted{% endif %}" style="{% if sort == 'views' %}background-color:#0066cc;color:white;{% endif %}">–ü–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º</a>
                </div>
            </div>
            <canvas id="booksChart"></canvas>
        </div>

        <!-- 2. –î–û–•–û–î–´ –ü–û –ü–ï–†–ò–û–î–ê–ú -->
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">üí∞ –î–æ—Ö–æ–¥—ã –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º</h3>
            <canvas id="revenueChart"></canvas>
        </div>

        <!-- 3. –¢–û–ü –ö–õ–ò–ï–ù–¢–û–í -->
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">üë• –¢–æ–ø –∫–ª–∏–µ–Ω—Ç—ã –ø–æ –∑–∞—Ç—Ä–∞—Ç–∞–º</h3>
            <canvas id="customersChart"></canvas>
        </div>

        <!-- 4. –†–ï–ô–¢–ò–ù–ì–ò –û–¢–ó–´–í–û–í -->
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">‚≠ê –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤</h3>
            <canvas id="ratingsChart"></canvas>
        </div>

        <!-- 5. –°–¢–ê–¢–£–°–´ –ó–ê–ö–ê–ó–û–í -->
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">üì¶ –°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π</h3>
            <canvas id="statusChart"></canvas>
        </div>

        <!-- 6. –ñ–ê–ù–†–´ -->
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">üé≠ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∂–∞–Ω—Ä—ã</h3>
            <canvas id="genresChart"></canvas>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
    <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #ddd;">
        <h3 style="margin-top: 0; margin-bottom: 15px; color: #333;">üë• –î–µ—Ç–∞–ª—å–Ω–æ: –¢–æ–ø –∫–ª–∏–µ–Ω—Ç—ã</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f9fafb; border-bottom: 2px solid #ddd;">
                    <th style="padding: 12px; text-align: left; font-weight: bold;">–ö–ª–∏–µ–Ω—Ç</th>
                    <th style="padding: 12px; text-align: left; font-weight: bold;">Email</th>
                    <th style="padding: 12px; text-align: center; font-weight: bold;">–ó–∞–∫–∞–∑–æ–≤</th>
                    <th style="padding: 12px; text-align: right; font-weight: bold;">–ü–æ—Ç—Ä–∞—Ç–∏–ª</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in top_customers %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px;">{{ customer.username }}</td>
                    <td style="padding: 12px;">{{ customer.email }}</td>
                    <td style="padding: 12px; text-align: center;">{{ customer.orders_count }}</td>
                    <td style="padding: 12px; text-align: right; font-weight: bold; color: #16a34a;">{{ customer.total_spent }} ‚ÇΩ</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–ø –∫–Ω–∏–≥ -->
    <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #ddd;">
        <h3 style="margin-top: 0; margin-bottom: 15px; color: #333;">üìö –î–µ—Ç–∞–ª—å–Ω–æ: –¢–æ–ø –∫–Ω–∏–≥–∏</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f9fafb; border-bottom: 2px solid #ddd;">
                    <th style="padding: 12px; text-align: left; font-weight: bold;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th style="padding: 12px; text-align: left; font-weight: bold;">–ê–≤—Ç–æ—Ä</th>
                    <th style="padding: 12px; text-align: center; font-weight: bold;">–ü—Ä–æ–¥–∞–Ω–æ</th>
                    <th style="padding: 12px; text-align: center; font-weight: bold;">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</th>
                    <th style="padding: 12px; text-align: right; font-weight: bold;">–¶–µ–Ω–∞</th>
                </tr>
            </thead>
            <tbody>
                {% for book in top_books %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px;"><strong>{{ book.title }}</strong></td>
                    <td style="padding: 12px;">{{ book.authors.all|join:", " }}</td>
                    <td style="padding: 12px; text-align: center;">{{ book.sales_count }}</td>
                    <td style="padding: 12px; text-align: center;">{{ book.view_count|default:0 }}</td>
                    <td style="padding: 12px; text-align: right; font-weight: bold; color: #0066cc;">{{ book.price }} ‚ÇΩ</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // –¶–≤–µ—Ç–∞ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º
    const colors = {
        primary: '#3b82f6',
        success: '#10b981',
        danger: '#ef4444',
        warning: '#f59e0b',
        info: '#0ea5e9',
        light: '#e5e7eb',
    };

    const bgColors = [
        'rgba(59, 130, 246, 0.7)',
        'rgba(16, 185, 129, 0.7)',
        'rgba(239, 68, 68, 0.7)',
        'rgba(245, 158, 11, 0.7)',
        'rgba(14, 165, 233, 0.7)',
        'rgba(168, 85, 247, 0.7)',
        'rgba(236, 72, 153, 0.7)',
        'rgba(249, 115, 22, 0.7)',
    ];

    const borderColors = [
        'rgb(59, 130, 246)',
        'rgb(16, 185, 129)',
        'rgb(239, 68, 68)',
        'rgb(245, 158, 11)',
        'rgb(14, 165, 233)',
        'rgb(168, 85, 247)',
        'rgb(236, 72, 153)',
        'rgb(249, 115, 22)',
    ];

    
    const booksCtx = document.getElementById('booksChart').getContext('2d');
    const booksMetricLabel = "{{ books_metric_label }}";
    new Chart(booksCtx, {
        type: 'doughnut',
        data: {
            labels: {{ books_labels|safe }},
            datasets: [{
                label: booksMetricLabel,
                data: {{ books_data|safe }},
                backgroundColor: bgColors,
                borderColor: borderColors,
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: { size: 12 },
                        padding: 15,
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return booksMetricLabel + ': ' + context.parsed;
                        }
                    }
                }
            }
        }
    });

    // 2. –î–û–•–û–î–´ –ü–û –ü–ï–†–ò–û–î–ê–ú - Line Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: {{ orders_labels|safe }},
            datasets: [{
                label: '–î–æ—Ö–æ–¥—ã (‚ÇΩ)',
                data: {{ revenue_data|safe }},
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderColor: 'rgb(16, 185, 129)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: 'rgb(16, 185, 129)',
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    labels: { font: { size: 12 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '–î–æ—Ö–æ–¥: ' + context.parsed.y + ' ‚ÇΩ';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + ' ‚ÇΩ';
                        }
                    }
                }
            }
        }
    });

    
    const customersCtx = document.getElementById('customersChart').getContext('2d');
    new Chart(customersCtx, {
        type: 'pie',
        data: {
            labels: {{ customers_labels|safe }},
            datasets: [{
                label: '–ó–∞—Ç—Ä–∞—Ç—ã (‚ÇΩ)',
                data: {{ customers_data|safe }},
                backgroundColor: bgColors,
                borderColor: borderColors,
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: { size: 11 },
                        padding: 15,
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '–ó–∞—Ç—Ä–∞—á–µ–Ω–æ: ' + context.parsed + ' ‚ÇΩ';
                        }
                    }
                }
            }
        }
    });

    // 4. –†–ï–ô–¢–ò–ù–ì–ò –û–¢–ó–´–í–û–í - Doughnut Chart
    const ratingsCtx = document.getElementById('ratingsChart').getContext('2d');
    new Chart(ratingsCtx, {
        type: 'doughnut',
        data: {
            labels: {{ ratings_labels|safe }},
            datasets: [{
                label: '–û—Ç–∑—ã–≤—ã',
                data: {{ ratings_data|safe }},
                backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#eab308', '#10b981'],
                borderColor: ['#dc2626', '#ea580c', '#d97706', '#ca8a04', '#059669'],
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { font: { size: 12 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '–û—Ç–∑—ã–≤–æ–≤: ' + context.parsed;
                        }
                    }
                }
            }
        }
    });

    // 5. –°–¢–ê–¢–£–°–´ –ó–ê–ö–ê–ó–û–í - Pie Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: {{ status_labels|safe }},
            datasets: [{
                label: '–ó–∞–∫–∞–∑—ã',
                data: {{ status_data|safe }},
                backgroundColor: [
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(245, 158, 11, 0.7)',
                    'rgba(239, 68, 68, 0.7)',
                ],
                borderColor: [
                    'rgb(16, 185, 129)',
                    'rgb(245, 158, 11)',
                    'rgb(239, 68, 68)',
                ],
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { font: { size: 12 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '–ó–∞–∫–∞–∑–æ–≤: ' + context.parsed;
                        }
                    }
                }
            }
        }
    });

    // 6. –ñ–ê–ù–†–´ - Bar Chart
    const genresCtx = document.getElementById('genresChart').getContext('2d');
    new Chart(genresCtx, {
        type: 'polarArea',
        data: {
            labels: {{ genres_labels|safe }},
            datasets: [{
                label: '–ü—Ä–æ–¥–∞–∂–∏',
                data: {{ genres_data|safe }},
                backgroundColor: bgColors,
                borderColor: borderColors,
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { font: { size: 11 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '–ü—Ä–æ–¥–∞–Ω–æ: ' + context.parsed.r;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
